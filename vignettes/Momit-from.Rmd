---
title: "Develop new from_ functions"
author: "Vincent Bonhomme"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{momit-from}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

## Philosophy

* In this vignette we will see how to extend Momit by writing a new `from_*` function. Actually, we will dissecate `from_tps` and recreate it using some helper functions.

* I am happy to provide support (`bonhomme.vincent@gmail.com`) for importing your foreign file format as new `from_*` function but I will ask you to include it in Momit. It will be useful only if it can handle the jungle of file formats available in the wild. Possibly not all `from_*` functions will end up with their `to_*` counterpart, yet I believe this is still a sensible deal.

## Create a new `from_` function.

In this example, we would like to import `nts` files into R, and possibly turn them into another format and/or use it into R directly.

Let's try to import the _Mosquito wings landmarks_ from the page curated by Jim Rohlf.

```{r}
library(Momit)
x <- readLines("http://life.bio.sunysb.edu/morph/data/RohlfSlice1990Mosq.nts")
head(x, 10)
```

`head` is quite ugly but shows characters that a `cat(x, sep="\n")` would not.

We have several problems here to make this stick to `.mom` definition:

* some comment lines (beginning with `"`) have to be skipped
* several indivuals are collated but they do not begin with a tilde
* some leading spaces are annoying but are, by default, trimmed by `Momit:::.prune` in `parse_mom`, so we will not need to manage this
* the line 4 indicate the downstream formatting but will be useless afterwards

Momit include some helper function to reformat such lines. They all begin with `brush_`. Of course, you can dissecate them (by typing the function name in the console without the brackets, eg `brush_as_comment`). They work by searching for a pattern and doing something. Pattern must be provided as a regular expression (see `?regex`). Regular expressions may appear boring to learn at first glance (they are), but they are very powerful in many places, so you time will not be spent in vain. Try to google `regular expressions`, you will find brilliant websites to help you on your way.

For instance, `brush_remove_lines` will search for a pattern and remove corresponding lines. HEre we want to drop lines containing `"`.
```{r}
x %>% brush_remove_lines('"') %>% head()
```

Better! Let's continue with this `1 127B 36 0`. Here the regex is slightly more subtle:

```{r}
x %>% 
  brush_remove_lines('"') %>% 
   brush_remove_lines("([[:alnum:]]+ ){3,}") %>%  # remove lines containing at least three space separated alphanumeric character(s)
  head()
```

We're approaching now. We need to add a tilde to single words:

```{r}
x_cleaned <- x %>% 
  brush_remove_lines('"') %>% 
   brush_remove_lines("([[:alnum:]]+ ){3,}") %>%  
  brush_add_tildes()
head(x_cleaned)
```

Sounds good! Once you've cleaned up a bit, you can try to parse it with `parse_mom`
  
```{r}
x_cleaned %>% parse_mom
```

Here you have the green light and the 127 individuals are succesfully imported. If this is not the case, continue to brush to make it shine before `parse_mom`.

This `premom_df` can now be `momify`ied. Something behind the curtain when you just use Momit with already written `from_`* functions.

```{r}
x_cleaned %>% parse_mom() %>% momify
```

We now just need to pack this pipeline into a function and we will have (re)created a `.nts` importer!

```{r}
# from_my_tps <- function(x, ...){
#  if (!is.list(x)){
#     x <- harvest(x, pattern="nts$", ...)
#   }
#   x %>%
#     # here, foreign files can be manipulated
#     # to look like a mom
#     # for mom, they are just parsed
#     parse_mom() %>% momify()
# }
```

Compare this with 

## Wild case: mosquito wings

Let's take a less trivial example, the _wings outlines_ dataset, from the same place.

Download it and inspect it:

```{r}
x <- readLines("http://life.bio.sunysb.edu/morph/data/RohlfArchieWingOutlines.nts")
head(x)
tail(x)
```

Damned ! 10 coordinates per line, some minus signs touching numbers, some empty lines, individuals are collated but not indicated, etc. To spice a bit our task, the dataset provided is not complete: we expect 2540 lines (each of the 127 individuals has 100 points, so 200 coordinates, so with 10 coordinates per line, 20 lines. We expect `127*20=2540` lines but 8 are missing. We first patch this by copying the last lines. Of course, that's just for the example.

```{r}
coo_per_ind <- brush_get_nts_nb_coo(x) # save the number of coordinates per individuals
x <- x %>%
  brush_remove_lines('"') %>%          # remove comments
  brush_remove_nts_dimensions() %>%    # remove the nts dimensions lines
  brush_remove_empty_lines()           # and empty lines
length(x)==2540                        # wrong number of lines
x <- c(x, x[2525:2532])                # copy the last lines so that it sums up to 2540
```

The (continuation of the) long pipe below introduces other brushes which names should be transparent. Dissecate it. 


```{r}
x <- x %>%
  brush_add_space_before("-") %>%
  brush_remove_leading_spaces() %>% 
  brush_reshape_lines(" ", 2) %>%      # 2 coordinates per line
  brush_insert_every(coo_per_ind)      # add individual names

# render some of it on the console
cat(x[1:5], "[.../...]", x[coo_per_ind + (1:5)],  sep="\n")
```

It starts to looks like a `.mom`! Let's try to parse it:

```{r}
x %>% parse_mom %>% momify
```

So the question is: is it worth the pain to import it using a custom importer? The answer is yes to my opinion. I spent a lot of time answering to Momocs' user questions about importing badly formatted data and this decided me to define `.mom` and write Momit. The hope is now twofold: homoegeneize morphometric data presentation and go around the jungle of existing morphometric formats.

Again, if you have some exotic data, wrote an `from_*` function and/or need help to do so, I will be there to help and include it in Momit.

