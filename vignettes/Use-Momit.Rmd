---
title: "Use Momit"
author: "Vincent Bonhomme"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
   
vignette: >
  %\VignetteIndexEntry{Momit_intro}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---
This vignette consists in two parts: 

1. a word on the rationale, definition and case studies around the mimimalist `.mom` file format for morphometric data;
2. examples on using Momit, how it works and what it brings to the often boring and time-consuming task of importing such data into R or converting them to another format.

Momit is still in active development, as part of [MomX](http://momx.online).

## `.mom` file format for morphometrics

#### Rationale
 * Morphometrics data essentially consist of coordinates and, if any, associated covariates.

* Existing morphometrics file format, eg `.tps`, `.nts`, `.xml`, etc. are not fully generic and/or explicitely defined/consistent, etc.

* Here is proposed the `.mom` (short for *mo*dern *m*orphometrics and to echo [`MomX`](https://github.com/MomX)) file format along with R utilities to import, parse, manipulate, export them.

* `.mom` files are easy to read, for humans, and to parse, for computers.

#### Definition
`.mom` files are plain text files whose single line syntax fall within one of the five following rules:

Rule | Pattern                 | What                          | Examples
-----|-------------------------|-------------------------------|--------------
 1   | space-separated numbers | coordinates in each dimension | `-0.5 0.5`; `0 0 0`
 2   | word and word/number    | covariate name and its value  | `scale 56`
 3   | single word             | partition of coordinates      | `LM` ; `out`
 4   | tilde and word          | shape name when collated      |  `~iris150`  ; `~H. sapiens`
 5   | anything else           | ignored                       | `#a comment`
 
Handling of units and of missing data is planned.

#### Examples

A single shape with one covariate:

```
name brahma
type beer
37  561
40  540
40  529
[...]
```
Two shapes with more covariates/cofactors:

```
~0001-cAglan_O10VD
var Aglan
domes cult
view VD
ind O10
-0.5000 0.00000
-0.4967 0.01035
-0.4935 0.02414
[...]
~0001-cAglan_O10VL 
var Aglan
domes cult
view VL
ind O10
-0.5000 0.00000
-0.4995 0.01018
-0.4957 0.02022
[...]
```

A single shape with landmarks and 2 partitions of semi-landmarks:

```
id 571
taxa T. mono
ldk
697  977
766  991
704 1046
[...]
sl1
541 962
542 965
543 967
[...]
sl2
541 949
542 952
542 954
[...]
```

A shape with nothing else but coordinates:

```
200   91
187   95
173  105
[...]
```
Examples adapted from [Momocs](https://github.com/vbonhomme/Momocs/): `bot[1]`, `olea[1]`, `charring[1]`, `shapes[1]`.

## Use Momit

#### General workflow
If you're here, you probably have morphometric data that you want to import into R and/or convert to another format. Momit aims at making this easy. Actually, most of the time, you will only need two (or even one) function to do this:

1. `from_*()`, that will find, read and parse them to a ``data_frame`
2. `to_*()` translate them and write to the format you want

The general workflow from (and possibly to) files on your machine and R's memory follows:

```
files  +--> from_*() +--------> to_*()  +---->   files
            └─ list.files       └─ soon
            └─ readLines
            └─ some polish†
            └─ list of single ind.
                └─ more polish†
                └─ parse†
                └─ momify
            └─ bind mom_df
            
└─: detail the main steps that happen behind the curtain
*: one of supported formats (eg. .mom, .tps, etc.)
†: depends on the format(ting) being treated
```

The only mandatory part below is `from_*`, in the case where you would only like to import `{.mom, .tps, .nts, etc.}` files into R (no convert, no export). See the first example below.

#### Case studies where it may saves time and enthusiasm

* You have `.mom` files in the folder "data", and want to import them into R:<br /> `from_mom("data/")`

```
# Not yet implemented

* You have `.tps` files and you want to collate them into a single `.mom` file:<br /> `from_tps() %>% to_mom() %>% write_single()`

* You have thousands of outlines of the same object, spread accross a messy (or neat) subfolders structures. Outlines coordinates represent two views (say lateral and dorsal), and saved as `.mom` files with the appropriate cofactor (say `view dorsal`) and you only want the dorsal outlines to be imported in Momocs:<br />
`from_mom() %>% filter(view=="dorsal") %>% to_Out()`
```

Talking about pipes, all [MomX](https://github.com/MomX) packages use them intensively, so you may want to read [some introduction to magrittr's](https://magrittr.tidyverse.org/articles/magrittr.html).

<!-- `from_tps` and `to_tps` -->
<!-- `from_nts` and `to_nps` -->

#### Behind the curtain
We will follow all the thing that happen along the path schematized above. You do not really need to understand (or even read) this section if you just want to convert your files. But in case you need to custom something, here is the long story.

Let's create a `.mom` file from scratch. It contains four individuals with some coordinates (we don't care whether they are outlines, curves, landmarks, etc. here they're truncated anyway) and four covariates: `var`iety, `domes`tication status, `view`,  `ind`ividual name and `size`.

We first load Momit (that re-exports magrittr's pipe), and friends. 
```{r dependencies, message=FALSE}
library(dplyr) # we will need it after
library(Momit)
library(Momocs) # same, and order matters since Momocs hacks some dplyr methods
```

Then I have a file named `foo.mom` in a folder named `mom_files` that I (both) created using:
```{r create_dummy, eval=FALSE}
dir.create("mom_files")
"~0001-cPastor_O10VD
var Pastor
domes cult
view VD
ind O10
size 2.23
-0.5000 0.00000
-0.4967 0.01035
-0.4935 0.02414
~0001-cPastor_O10VL 
var Pastor
domes cult
view VL
ind O10
size 2.43
-0.5000 0.00000
-0.4995 0.01018
-0.4957 0.02022
~0001-cIvorra_O11VL 
var Ivorra
domes wild
view VL
ind O11
size 2.56
-0.5000 0.00000
-0.4985 0.0112
-0.4845 0.021
~0001-cIvorra_O11VD 
var Ivorra
domes wild
view VD
ind O11
size 2.74
-0.5000 0.00000
-0.4995 0.011
-0.49 0.0198
~0005-cBonhomme_O11VD 
var Bonhomme
domes wild
view VD
ind O11
size 2.55
-0.5000 0.00000
-0.499 0.012
-0.49 0.0186" %>% 
  writeLines("mom_files/foo.mom")
```

We can now read this file:
```{r read_dummy, eval=FALSE}
readLines("mom_files/foo.mom")
```

`harvest()` function will find all the files, when provided containing folder(s) or, better, a pattern which is a regular expression. If you are not yet familiar with regular expression, go learn them, they are among the most profitable investment you can make when talking to a computer.

A list of files, read as lines, is returned. In most cases, `from_*` functions will harvest files for you, and a list of folders/files can also be passed directly to `from_*` functions. See those examples.

If you actually created the file and folder this should work now:
```{r parse_dummy1, eval=FALSE}
x <- from_mom("mom_files/foo.mom")
```

Otherwise just use `example_data` (see `?example_data`):
```{r, eval=TRUE}
x <- from_mom("mom_files/foo.mom", where=example_dir())
x
```

We now have a `mom_df`: a `data.frame` containing:
 * several individuals
 * each with names, covariates and coordinates

Some equivalent of this importing step follows. They may be useful to understand should you want to write your own importers. As long as your format is used by others, I will be happy to write it myself and include it in Momocs. Just drop me a line.
```{r, eval=FALSE}
# from_mom("mom_files") # will find all .mom files in "mom_files/"
# from_mom()            # will find all .mom files in the working 
                        # directory (I can't myself because I have 
                        # more than one in my Momit folder)

# Below, what's done by from_mom()
# list.files("mom_files/", full.names=TRUE) %>% 
#  lapply(readLines) %>% 
#  parse_mom()
```

The last lines reproduce what is internally done by `from_mom`. Let's see what it contains. Note the absence of parentheses, that prints the definition of the function.

```{r access_definition}
from_mom
```

`harvest` itself eases the passing of selected files. All `from_*` functions have the same skeleton. You can dissecate it with `harvest` (again, no quotes). Note that this is not peculiar to Momit, it would work with all R functions. For methods, you will need to add the concerned class (eg `print.data.frame`).

#### Handling imported data: data.frame is life, data.frame is love

Because once you started to like, you will love it. Particularly if you do some "modern R". If you never heard of it or if you do not think it's worth the pain, let me disagree with you and please read the [dplyr's introduction](https://dplyr.tidyverse.org/articles/dplyr.html) (5 min), and [_R for data science_](http://r4ds.had.co.nz/) (from 2 days to 2 years). 

Alternatively, just keep reading this vignette.

Did you ever need to filter some data to retain only some, say species; or to transforms some variables? Of course you did. With `dplyr` handling data becomes easy. All operations that follow depends on `dplyr`'s verbs that work just like exemplified in the vignette mentionned above since `mom_df` (what is returned by the `from_` importers is _also_ a `data.frame`).

##### Selecting columns
You can use `select` to select, reorder, rename some columns:
```{r select}
select(x, name, coo, size)
select(x, -view, author=var)
select(x, 1:2, coo)
```

##### Creating new columns
`mutate` is your friend. 

As you may have noticed, all columns but coordinates partitions are of class `character`. __You should explicitely redeclare the class of each covariate columns__. This seems boring at the first glance but I want you to a lot of time/enthusiasm in the end. The good news is that you can do it easily with `mutate`:

```{r mutate}
sapply(x, class)

x <- mutate(x,
           var=   as.factor(var),
           domes= as.factor(var),
           view=  as.factor(view),
           ind=   as.factor(ind),
           size=  as.numeric(size))
# If you have many columns, you can try one of mutate variants.

# see how the labels below column names have changed.
# below is the x, you shoud use for further analyses (mostly if you stay in R)
x 
```

`mutate` can also be used to create new columns on the fly:

```{r mutate2}
mutate(x,
       size_2=size^2,
       size_sqrt=sqrt(size),
       view=factor(substr(view, 2, 2)))
```

##### Filtering
```{r}
# only pictures by Ivorra
x 
filter(x, var=="Ivorra")

# remove those by Bonhomme
filter(x, var!="Bonhomme")
# alternatively
filter(x, var %in% c("Ivorra", "Pastor"))

# more conditions
x %>% filter(var=="Ivorra", view=="VL")

# or filtering on numeric values
x %>% filter(size < 2.5)
x %>% filter(size >= median(size))
```

##### Selectiong by rows
If you need to select individuals by their positions, yet usually that's not a good idea, you can use `slice`:

```{r slice}
x
slice(x, 1)
slice(x, -(3:5))
```

## Continue with Momocs
Whether you just want an overview of your data or do all the analyses with Momocs, going there from Momit is straightforward.

```{r Momocs, eval=FALSE}
library(Momocs)
x
Out(x) # equivalent to Out(x$coo, dplyr::select(x, -coo))
Out(x) %>% panel # just a panel plot (ugly but we used dummy data)
# equivalent to
# Out(x$coo) %>% panel
# or if this is not outlines but landmarks:
Ldk(x)
# or curves, again, dead simple
Opn(x)
```

Once you have a `Coo` object, you enter the `Momocs` zone, eg:
```{r Momocs2, eval=FALSE}
Ldk(x$coo, fac=select(x, -coo)) %>% # build the Ldl
  fgProcrustes(tol=0.1) %T>%        # high tol, save trees
  LDA(~domes) %>%                   # discriminant analysis then continue to PCA
  PCA() %T>% 
  plot_PCA(~size) %>%               # plotting vs a numeric
  plot_PCA(~var)                    # and versus a factor
```

## Convert and write files

TODO


-----
If you created the files, don't forget to remove them!
```{r}
file.remove("mom_files/foo.mom")
unlink("mom_files", recursive=TRUE, force=TRUE)
```

## Final word
 * I will add more `from_*` and `to_*` functions asap
 * I also still need to implement missing values handling and units.
 * All of this is pretty experimental so all comments are welcome.
 * Please use GitHub issues for bugs/ideas. If you'd like to get in touch privately or send me some exotic data to be included in Momit, you can email me at: `bonhomme.vincent@gmail.com`.
 * More to come.






