---
title: "Use Momit"
author: "Vincent Bonhomme"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{momit-usage}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

## General workflow
```
                     character        mod_df       character

files  +--> harvest() +----> from_*() +----> to_*()  +---->   files
```
_classes above functions indicates the R zone, otherwise we talk about files on a machine._

1. You have morphometric data
2. `from_*()` find, read and parse them to a `mom_df` `data.frame`
3. `to_*()` translate them to the format you want
4. `write_*` these files.

The only mandatory part below is `from_*`, in the case where you would only like to import `{.mom, .tps, .nts, etc.}` files into R (no convert, no export). See the first example below.

## Examples

* You have `.mom` files in the folder "data", and want to import them into R:<br /> `from_mom("data")`

* Same but wih `.tps`files and you want to collate them into a single `.mom` file:<br /> `from_tps() %>% to_mom() %>% write_single()`

* You have thousands of outlines of the same object, spread accross a messy subfolders structures (true story and shame and you !). Outlines coordinates represent two views (say lateral and dorsal), and saved as `.mom` files with the appropriate cofactor (say `view dorsal`) and you only want the dorsal outlines to be imported in Momocs:<br />
`harvest(your_list_of_messy_folders_where_files_are) %>% from_mom() %>% filter(view=="dorsal") %>% to_Out()`

Talking about pipes, all [MomX](https://github.com/MomX) packages use them intensively, so you may want to read [magrittr's vignette](https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html)

Of course, `from_` and `to_` functions are easy to add to convert from/to any file format. An example will be given in a dedicated vignette. So far, Momit has the following functions:

**TODO**
<!-- `from_tps` and `to_tps` -->
<!-- `from_nts` and `to_nps` -->

## Behind the curtain
We will follow all the thing that happen along the path schematized above. You do not really need to understand (or even read) this section if you just want to convert your files. But in case you need to custom something, here is the long story.

Let's create a `.mom` file from scratch. It contains four individuals with some coordinates (we don't care whether they are outlines, curves, landmarks, etc. here they're truncated anyway) and four covariates: `var`iety, `domes`tication status, `view`,  `ind`ividual name and `size`.

We first load Momit (that re-exports magrittr's pipe), then we write the lines below in a dedicated folder to simulate such a file.
```{r}
library(Momit)
dir.create("mom_files")
"~0001-cPastor_O10VD
var Pastor
domes cult
view VD
ind O10
size 2.23
-0.5000 0.00000
-0.4967 0.01035
-0.4935 0.02414
~0001-cPastor_O10VL 
var Pastor
domes cult
view VL
ind O10
size 2.43
-0.5000 0.00000
-0.4995 0.01018
-0.4957 0.02022
~0001-cIvorra_O11VL 
var Ivorra
domes wild
view VL
ind O11
size 2.56
-0.5000 0.00000
-0.4985 0.0112
-0.4845 0.021
~0001-cIvorra_O11VD 
var Ivorra
domes wild
view VD
ind O11
size 2.74
-0.5000 0.00000
-0.4995 0.011
-0.49 0.0198" %>% writeLines("mom_files/foo.mom")
```

We can now read this file:
```{r}
readLines("mom_files/foo.mom")
```

`harvest()` function will find all the files, when provided containing folder(s) or directly a list of files. A list of files, read as lines, is returned. In most cases, `from_*` functions will harvest files for you, and a list of folders/files can also be passed directly to `from_*` functions. See those examples.

```{r}
from_mom("mom_files/foo.mom")
# Some equivalents:
# from_mom("mom_files") # will find all .mom files in "mom_files/"
# from_mom()            # will find all .mom files in the working 
                        # directory (I can't myself because I have 
                        # more than one in my Momit folder)
# harvest(getwd(), pattern="mom$") %>% from_mom() # same
# list.files("mom_files", pattern="mom$", recursive=TRUE, full.names = TRUE) %>% 
#           from_mom()                            # the longest possible command
```

This list is parsed to a `premom_df`. Just a `data.frame` with a custom print method that would help find problems, should you want to develop your own `from` function.

What we want to import is a `.mom` file, so we need `from_mom`. Let's see what it contains. Note the absence of parentheses, that prints the definition of the function.

```{r}
from_mom
```

All `from_*` functions have the same skeleton. Let's dissecate its components, first `harvest`. It is just a convenient wrapper around `list.files` that will find files (here only files ending with `mom`). Then, `parse_mom`.

```{r}
harvest("mom_files") %>% parse_mom()
```

Here we have the parsed `data.frame`. Apparently everything gone fine. Let's simulate a wrong syntax in the `.mom` file.

```{r}
m <- harvest("mom_files")
m[[1]][5] <- "0.5; please crash"
m %>% parse_mom
```

So this function is pretty useful if you're developping your own `from_function`. A dedicated vignette will follow. 

`momify` then combines this `data.frame` into a `mom_df` that you already encountered since we recreated `from_mom`.

```{r}
df <- harvest("mom_files") %>% parse_mom() %>% momify()
# equivalent to df <- from_mom("mom_files")
```

The only pain here is to manually declare all columns classes (see the `mutate` below). The good news is that it's pretty cool to have a `data.frame` to store morphometric data ([and data as a whole](https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html)), since you can very easily manipulate them.

```{r}
library(dplyr)
# retain only the first two shapes
df %>% slice(1:2) 
# only dorsal views
df %>% filter(view=="VD") 
# create a new column on the fly
# and retain only the upper half
df %>% 
  mutate(size2=as.numeric(size)*2) %>% 
  filter(size2 > median(size2))
```

And of course you can turn back this `data.frame` to character thant can later be written to individual or separate `.mom` files or any other available file format.

```{r}
df %>% to_mom() # hmmm, that looks like a .mom
df %>% to_mom() %>% write_single("plop.mom") # let's write it into a single file
readLines("plop.mom")
```

Yes, we end up with the same information as in  `foo.mom`, only the order of covariates/coordinates changes.

Don't forget to remove these files and folder!
```{r, echo=FALSE}
file.remove("plop.mom", "mom_files/foo.mom")
unlink("mom_files", recursive=TRUE, force=TRUE)
```

## Final word
 * I will add `from_*` and `to_*` functions asap in spring 2018.
 * I also still need to implement missing values handling and units.
 * All of this is pretty experimental so all comments are welcome.
 * Please use GitHub issues for bugs/ideas. If you'd like to get in touch privately or send me some exotic data to be included in Momit, you can email me at: `bonhomme.vincent@gmail.com`.
 * More to come.
 
 





